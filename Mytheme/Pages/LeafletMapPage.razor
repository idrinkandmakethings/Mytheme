
@using Mytheme.Data.Dto
@using Mytheme.Map.Models
@using Mytheme.Modals
@using Mytheme.Models
@using Mytheme.Services
@using Mytheme.Services.Interfaces
@using Serilog

@inject IFileHandlerService FileHandlerService

@inject BreadcrumbService BreadcrumbService
@inject NavigationManager NavigationManager
@inject SvgHelperService SvgHelperService
@inject IJSRuntime JsRuntime
@inject IModalService ModalService
@inject IMapService MapService


<Styled @bind-Classname="@mapStyle">
    position: relative;
    width: 100%;
    height: 100%;
</Styled>

<LeafletMap OnMarkerAdded="MarkerAdded" @ref="@mapView"></LeafletMap>


@code {

    private string mapStyle;

    MapImage map;
    LeafletMap mapView;

    [Parameter]
    public EventCallback<NavigationLink> OnNavigate { get; set; }

    [Parameter]
    public MapPage MapPage { get; set; }


    protected override async Task OnParametersSetAsync()
    {
        if (MapPage != null && MapPage?.Id != Guid.Empty)
        {
            BreadcrumbService.SetBreadCrumb(MapPage?.Name, MapPage?.Id.ToString(), true);

            SetNavBarButtons();

            await LoadMap();
        }
        else if (MapPage?.Id == Guid.Empty)
        {   
            OpenNewMapPageModal();
        }
    }

    
    private void SetNavBarButtons()
    {

        var buttons = new List<NavBarButton>();

        buttons.Add(new NavBarButton("Save", SvgName.Save, SaveMapPage));
        buttons.Add(new NavBarButton("Delete", SvgName.Delete, ShowDeleteModal));

        BreadcrumbService.SetNavBarButtons(buttons);
    }

    private async Task LoadMap()
    {
        var result = await FileHandlerService.GetMapImage(MapPage.Image);

        map = result;

        await mapView.InitializeMap(map);

        foreach (var marker in MapPage.MapMarkers)
        {
            await mapView.AddMarker(marker.ToLeafletMarker());
        }

        StateHasChanged();
    }

    private async void MarkerAdded(Coordinate coord)
    {
        var p = new ModalParameters();
        p.Add("lat", coord.Latitude);
        p.Add("lon", coord.Longitude);
        p.Add("parent", MapPage.Id);

        ModalService.Show<AddMapMarkerModal>("Add Map Marker", p,
            new ModalOptions
            {
                HeaderColor = "white",
                HeaderBackgroundColor = "black",
                PixelWidth = 800,
                DisableBackgroundCancel = true
            }, OnMapMarkerModalClosed);
    }

    private async void SaveMapPage()
    {

        if (MapPage.Id == Guid.Empty)
        {
            var result = await MapService.AddMapPageAsync(MapPage);

            if (result.IsSuccess)
            {
                MapPage.Id = result.Result;

                BreadcrumbService.SetBreadCrumb(MapPage.Name, MapPage.Id.ToString(), false);
            }
            else
            {
                ModalService.ShowInfoModal($"Error Saving Page", result.Message);
            }
        }
        else
        {
            var result = await MapService.UpdateMapPageAsync(MapPage);

            if (!result.IsSuccess)
            {
                ModalService.ShowInfoModal($"Error Saving Page", result.Message);
            }
        }
    }

    private void ShowDeleteModal()
    {

    }

    private async void DeleteMapPage()
    {

    }

    protected void OpenNewMapPageModal()
    {
        var p = new ModalParameters();
        p.Add("parent", MapPage.FK_Section);

        ModalService.Show<AddNewMapPageModal>("Add New Map", p,
            new ModalOptions
            {
                HeaderColor = "white",
                HeaderBackgroundColor = "black",
                PixelWidth = 360,
                DisableBackgroundCancel = true
            }, OnModalClosed);
    }

    private async void OnModalClosed(ModalResult result)
    {
        if (!result.Cancelled)
        {
            try
            {
                MapPage = (MapPage) result.Data;
                SaveMapPage();
                await LoadMap();
                BreadcrumbService.RefreshIndex();
            }
            catch (Exception e)
            {
                ModalService.ShowInfoModal($"Error", $"An unknown error occured.{Environment.NewLine}Msg:{e.Message}");
                Log.Error(e, "Exception initializing map page after modal creation");
            }
        }
        else
        {
            // TODO: go back in navigation...
        }
    }

    private async void OnMapMarkerModalClosed(ModalResult result)
    {
        if (!result.Cancelled)
        {
            try
            {
                var marker = (MapMarker) result.Data;

                MapPage.MapMarkers.Add(marker);

                var dalResult = await MapService.AddMarkerAsync(marker);

                marker.Id = dalResult.Result;

                await mapView.AddMarker(marker.ToLeafletMarker());

                SaveMapPage();
            }
            catch (Exception e)
            {
                ModalService.ShowInfoModal($"Error", $"An unknown error occured.{Environment.NewLine}Msg:{e.Message}");
                Log.Error(e, "Exception adding map marker.");
            }
        }
    }

}